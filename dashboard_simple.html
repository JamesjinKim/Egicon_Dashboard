<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZ-Dash Ïã¨Ìîå ÏÑºÏÑú ÎåÄÏãúÎ≥¥Îìú</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            color: white;
            margin-bottom: 20px;
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .sensor-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 280px;
        }

        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--sensor-color);
        }

        .sensor-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .sensor-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--sensor-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .sensor-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .sensor-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--sensor-color);
            margin-bottom: 10px;
        }

        .sensor-unit {
            font-size: 1.2rem;
            color: #666;
            font-weight: normal;
        }

        .sensor-info {
            font-size: 0.9rem;
            color: #888;
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-bottom: 15px;
        }

        .sensor-chart {
            height: 80px;
            margin-top: 15px;
        }

        .sensor-chart canvas {
            max-height: 80px !important;
        }

        /* ÏÑºÏÑúÎ≥Ñ ÏÉâÏÉÅ */
        .temperature {
            --sensor-color: #ff6b6b;
        }

        .humidity {
            --sensor-color: #4ecdc4;
        }

        .light {
            --sensor-color: #ffe66d;
        }

        .pressure {
            --sensor-color: #a8e6cf;
        }

        .vibration {
            --sensor-color: #ff8b94;
        }

        .air-quality {
            --sensor-color: #88d8b0;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .footer {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 40px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .sensors-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .sensor-value {
                font-size: 2.5rem;
            }
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .updating {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> EZ-Dash ÏÑºÏÑú Î™®ÎãàÌÑ∞</h1>
        <div class="status" id="status">
            <i class="fas fa-circle" id="status-icon"></i>
            <span id="status-text">Ïó∞Í≤∞ Ï§ë...</span>
            <span id="last-update"></span>
        </div>
    </div>

    <div class="sensors-grid" id="sensors-grid">
        <!-- Ïò®ÎèÑ ÏÑºÏÑú -->
        <div class="sensor-card temperature">
            <div class="sensor-header">
                <div class="sensor-icon">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="sensor-title">Ïò®ÎèÑ</div>
            </div>
            <div class="sensor-value">
                <span id="temperature-value" class="loading">--</span>
                <span class="sensor-unit">¬∞C</span>
            </div>
            <div class="sensor-info" id="temperature-info">BME688 ÏÑºÏÑú</div>
            <div class="sensor-chart">
                <canvas id="temperature-chart"></canvas>
            </div>
        </div>

        <!-- ÏäµÎèÑ ÏÑºÏÑú -->
        <div class="sensor-card humidity">
            <div class="sensor-header">
                <div class="sensor-icon">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="sensor-title">ÏäµÎèÑ</div>
            </div>
            <div class="sensor-value">
                <span id="humidity-value" class="loading">--</span>
                <span class="sensor-unit">%</span>
            </div>
            <div class="sensor-info" id="humidity-info">BME688 ÏÑºÏÑú</div>
            <div class="sensor-chart">
                <canvas id="humidity-chart"></canvas>
            </div>
        </div>

        <!-- Ï°∞ÎèÑ ÏÑºÏÑú -->
        <div class="sensor-card light">
            <div class="sensor-header">
                <div class="sensor-icon">
                    <i class="fas fa-sun"></i>
                </div>
                <div class="sensor-title">Ï°∞ÎèÑ</div>
            </div>
            <div class="sensor-value">
                <span id="light-value" class="loading">--</span>
                <span class="sensor-unit">lux</span>
            </div>
            <div class="sensor-info" id="light-info">BH1750 ÏÑºÏÑú</div>
            <div class="sensor-chart">
                <canvas id="light-chart"></canvas>
            </div>
        </div>

        <!-- Ï∞®Ïïï ÏÑºÏÑú -->
        <div class="sensor-card pressure">
            <div class="sensor-header">
                <div class="sensor-icon">
                    <i class="fas fa-compress-alt"></i>
                </div>
                <div class="sensor-title">Ï∞®Ïïï</div>
            </div>
            <div class="sensor-value">
                <span id="pressure-value" class="loading">--</span>
                <span class="sensor-unit">Pa</span>
            </div>
            <div class="sensor-info" id="pressure-info">BME688 Í∏∞Ï§Ä ÎåÄÍ∏∞Ïïï Î≥ÄÌôò</div>
            <div class="sensor-chart">
                <canvas id="pressure-chart"></canvas>
            </div>
        </div>

        <!-- ÏßÑÎèô ÏÑºÏÑú -->
        <div class="sensor-card vibration">
            <div class="sensor-header">
                <div class="sensor-icon">
                    <i class="fas fa-wave-square"></i>
                </div>
                <div class="sensor-title">ÏßÑÎèô</div>
            </div>
            <div class="sensor-value">
                <span id="vibration-value" class="loading">--</span>
                <span class="sensor-unit">g</span>
            </div>
            <div class="sensor-info" id="vibration-info">ÏãúÍ∞ÑÎåÄÎ≥Ñ Í∞ÄÏÉÅ ÏÑºÏÑú</div>
            <div class="sensor-chart">
                <canvas id="vibration-chart"></canvas>
            </div>
        </div>

        <!-- Í≥µÍ∏∞Ïßà ÏÑºÏÑú -->
        <div class="sensor-card air-quality">
            <div class="sensor-header">
                <div class="sensor-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="sensor-title">Í≥µÍ∏∞Ïßà</div>
            </div>
            <div class="sensor-value">
                <span id="air-quality-value" class="loading">--</span>
                <span class="sensor-unit">/100</span>
            </div>
            <div class="sensor-info" id="air-quality-info">BME688 Í∞ÄÏä§ Ï†ÄÌï≠ Í∏∞Î∞ò</div>
            <div class="sensor-chart">
                <canvas id="air-quality-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>üöÄ EZ-Dash Ïã§ÏãúÍ∞Ñ ÏÑºÏÑú Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏä§ÌÖú</p>
        <p>ÎùºÏ¶àÎ≤†Î¶¨ÌååÏù¥ 4 + BME688 + BH1750</p>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';
        
        let updateInterval;
        let isUpdating = false;
        
        // Ï∞®Ìä∏ Í∞ùÏ≤¥ Ï†ÄÏû•
        const charts = {};
        
        // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÌûàÏä§ÌÜ†Î¶¨ (ÏµúÍ∑º 10Í∞ú Ìè¨Ïù∏Ìä∏)
        const sensorHistory = {
            temperature: [],
            humidity: [],
            light: [],
            pressure: [],
            vibration: [],
            airQuality: [],
            timestamps: []
        };
        
        const MAX_HISTORY_POINTS = 10;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('EZ-Dash Ïã¨Ìîå ÎåÄÏãúÎ≥¥Îìú ÏãúÏûë');
            
            // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
            initializeCharts();
            
            // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            updateSensorData();
            
            // 3Ï¥àÎßàÎã§ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
            updateInterval = setInterval(updateSensorData, 3000);
            
            // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
            window.addEventListener('beforeunload', function() {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
            });
        });

        // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        async function updateSensorData() {
            if (isUpdating) return;
            isUpdating = true;
            
            try {
                // ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë ÌëúÏãú
                document.querySelectorAll('.sensor-card').forEach(card => {
                    card.classList.add('updating');
                });
                
                // ÌòÑÏû¨ ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const response = await fetch(`${API_BASE}/current`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // ÏÑºÏÑú ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
                const statusResponse = await fetch(`${API_BASE}/status`);
                const statusData = await statusResponse.json();
                
                // ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                addToHistory(data);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateSensorDisplay(data);
                updateStatus(statusData, data.timestamp);
                
                // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                updateAllCharts();
                
                console.log('ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å:', data);
                
            } catch (error) {
                console.error('ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                updateStatus({ connected: false, error: error.message });
                
                // ÏóêÎü¨ Ïãú Í∞íÎì§ÏùÑ ÏóêÎü¨ ÏÉÅÌÉúÎ°ú ÌëúÏãú
                const sensors = ['temperature', 'humidity', 'light', 'pressure', 'vibration', 'air-quality'];
                sensors.forEach(sensor => {
                    const element = document.getElementById(`${sensor}-value`);
                    if (element) {
                        element.textContent = 'Ïò§Î•ò';
                        element.className = 'error';
                    }
                });
            } finally {
                // ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë ÌëúÏãú Ï†úÍ±∞
                document.querySelectorAll('.sensor-card').forEach(card => {
                    card.classList.remove('updating');
                });
                isUpdating = false;
            }
        }

        // ÏÑºÏÑú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateSensorDisplay(data) {
            // Ïò®ÎèÑ
            updateSensorValue('temperature', data.temperature, 1);
            
            // ÏäµÎèÑ
            updateSensorValue('humidity', data.humidity, 1);
            
            // Ï°∞ÎèÑ
            updateSensorValue('light', data.light, 0);
            
            // Ï∞®Ïïï
            updateSensorValue('pressure', data.pressure, 1);
            
            // ÏßÑÎèô
            updateSensorValue('vibration', data.vibration, 2);
            
            // Í≥µÍ∏∞Ïßà
            updateSensorValue('air-quality', data.air_quality, 0);
            
            // Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('temperature-info').textContent = 
                `BME688 ÏÑºÏÑú (Ï†àÎåÄÏïïÎ†•: ${data.absolute_pressure.toFixed(1)} hPa)`;
            document.getElementById('air-quality-info').textContent = 
                `Í∞ÄÏä§Ï†ÄÌï≠: ${data.gas_resistance.toFixed(0)} Œ©`;
        }

        // Í∞úÎ≥Ñ ÏÑºÏÑú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
        function updateSensorValue(sensorId, value, decimals) {
            const element = document.getElementById(`${sensorId}-value`);
            if (element) {
                if (typeof value === 'number') {
                    element.textContent = value.toFixed(decimals);
                    element.className = '';
                } else {
                    element.textContent = '--';
                    element.className = 'loading';
                }
            }
        }

        // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStatus(statusData, timestamp) {
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            const lastUpdate = document.getElementById('last-update');
            
            if (statusData.connected) {
                statusIcon.style.color = '#4caf50';
                statusText.textContent = `ÏÑºÏÑú Ïó∞Í≤∞Îê® (${statusData.total_sensors}/2)`;
                
                if (timestamp) {
                    const time = new Date(timestamp).toLocaleTimeString();
                    lastUpdate.textContent = ` | ÏóÖÎç∞Ïù¥Ìä∏: ${time}`;
                }
            } else {
                statusIcon.style.color = '#f44336';
                statusText.textContent = statusData.error ? `Ïò§Î•ò: ${statusData.error}` : 'ÏÑºÏÑú Ïó∞Í≤∞ ÏïàÎê®';
                lastUpdate.textContent = '';
            }
        }

        // Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
        function initializeCharts() {
            const chartConfigs = [
                { id: 'temperature-chart', color: '#ff6b6b', type: 'line' },
                { id: 'humidity-chart', color: '#4ecdc4', type: 'line' },
                { id: 'light-chart', color: '#ffe66d', type: 'bar' },
                { id: 'pressure-chart', color: '#a8e6cf', type: 'line' },
                { id: 'vibration-chart', color: '#ff8b94', type: 'bar' },
                { id: 'air-quality-chart', color: '#88d8b0', type: 'line' }
            ];

            chartConfigs.forEach(config => {
                const ctx = document.getElementById(config.id);
                if (ctx) {
                    charts[config.id] = new Chart(ctx.getContext('2d'), {
                        type: config.type,
                        data: {
                            labels: Array(MAX_HISTORY_POINTS).fill(''),
                            datasets: [{
                                data: Array(MAX_HISTORY_POINTS).fill(null),
                                borderColor: config.color,
                                backgroundColor: config.type === 'bar' 
                                    ? config.color + '80'  // 50% Ìà¨Î™ÖÎèÑ
                                    : 'transparent',
                                borderWidth: 2,
                                pointRadius: 2,
                                pointHoverRadius: 4,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            },
                            scales: {
                                x: { display: false },
                                y: { 
                                    display: false,
                                    beginAtZero: false
                                }
                            },
                            elements: {
                                point: { radius: 0 }
                            },
                            animation: {
                                duration: 500
                            }
                        }
                    });
                }
            });
        }

        // ÌûàÏä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞Ïóê ÏÉà Í∞í Ï∂îÍ∞Ä
        function addToHistory(data) {
            // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
            const timeLabel = new Date(data.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            sensorHistory.timestamps.push(timeLabel);
            sensorHistory.temperature.push(data.temperature);
            sensorHistory.humidity.push(data.humidity);
            sensorHistory.light.push(data.light);
            sensorHistory.pressure.push(data.pressure);
            sensorHistory.vibration.push(data.vibration);
            sensorHistory.airQuality.push(data.air_quality);

            // ÏµúÎåÄ Ìè¨Ïù∏Ìä∏ Ïàò Ï†úÌïú
            Object.keys(sensorHistory).forEach(key => {
                if (sensorHistory[key].length > MAX_HISTORY_POINTS) {
                    sensorHistory[key].shift();
                }
            });
        }

        // Î™®Îì† Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateAllCharts() {
            const chartMappings = [
                { id: 'temperature-chart', data: sensorHistory.temperature },
                { id: 'humidity-chart', data: sensorHistory.humidity },
                { id: 'light-chart', data: sensorHistory.light },
                { id: 'pressure-chart', data: sensorHistory.pressure },
                { id: 'vibration-chart', data: sensorHistory.vibration },
                { id: 'air-quality-chart', data: sensorHistory.airQuality }
            ];

            chartMappings.forEach(mapping => {
                const chart = charts[mapping.id];
                if (chart) {
                    chart.data.labels = [...sensorHistory.timestamps];
                    chart.data.datasets[0].data = [...mapping.data];
                    chart.update('none'); // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏù¥ Îπ†Î•∏ ÏóÖÎç∞Ïù¥Ìä∏
                }
            });
        }

        // ÏóêÎü¨ Ï≤òÎ¶¨ Ìï®Ïàò
        function showError(message) {
            const grid = document.getElementById('sensors-grid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            grid.insertBefore(errorDiv, grid.firstChild);
            
            // 5Ï¥à ÌõÑ ÏóêÎü¨ Î©îÏãúÏßÄ Ï†úÍ±∞
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>