ì´ í”„ë¡œì íŠ¸ëŠ” ë¼ì¦ˆë² ë¦¬íŒŒì´ 4B ëª¨ë¸ B ë²„ì „ì—ì„œ ì‘ë™í•˜ëŠ” í”„ë¡œì íŠ¸ë¡œ ì•„ë˜ì™€ ê°™ì€ êµ¬ì¡°ë¥¼ ê°–ê³  ìˆìŠµë‹ˆë‹¤.
egdash/
â”œâ”€â”€ templates/               # Flask í…œí”Œë¦¿ íŒŒì¼ë“¤
â”‚   â”œâ”€â”€ base.html           # ê¸°ë³¸ ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿
â”‚   â”œâ”€â”€ index.html          # ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ (ë ˆê±°ì‹œ)
â”‚   â”œâ”€â”€ pages/              # í˜ì´ì§€ë³„ í…œí”Œë¦¿
â”‚   â”‚   â””â”€â”€ dashboard.html  # ë©”ì¸ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
â”‚   â””â”€â”€ components/         # ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸ë“¤
â”‚
â”œâ”€â”€ static/                 # ì •ì  íŒŒì¼ë“¤
â”‚   â”œâ”€â”€ css/               # CSS ìŠ¤íƒ€ì¼ì‹œíŠ¸
â”‚   â”‚   â””â”€â”€ styles.css     # ë©”ì¸ ìŠ¤íƒ€ì¼ì‹œíŠ¸
â”‚   â”œâ”€â”€ js/                # JavaScript íŒŒì¼ë“¤
â”‚   â”‚   â””â”€â”€ script.js      # ë©”ì¸ JavaScript
â”‚   â””â”€â”€ images/            # ì´ë¯¸ì§€ íŒŒì¼ë“¤
â”‚
â”œâ”€â”€ sensor_api_simple.py   # Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ì¸ íŒŒì¼
â””â”€â”€ sensor_manager.py      # ì„¼ì„œ ê´€ë¦¬ ëª¨ë“ˆ

ê·¸ ì¤‘ì—ì„œ í•µì‹¬ ëª¨ë‘˜ì€ 
sensor_api_simple.py   # Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ì¸ íŒŒì¼
sensor_manager.py      # ì„¼ì„œ ê´€ë¦¬ ëª¨ë“ˆ
ë‘˜ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë‘ ëª¨ë“ˆì´ ì„¼ì„œë¥¼ ì ‘ê·¼í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì„ ê°œì„ í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

1.constants.py íŒŒì¼ì€ BME688 ì„¼ì„œ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° í•„ìš”í•œ ìƒìˆ˜ë“¤ì„ ì •ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. 
ì´ íŒŒì¼ì€ ìˆ˜ì •ì—†ì´ ê³„ì† ìœ ì§€í•˜ê³  BME688 ì„¼ì„œ Classì—ì„œ ì°¸ì¡°í•˜ë©´ ë©ë‹ˆë‹¤.
2.database.py íŒŒì¼ì€ ì„¼ì„œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ëŠ” ë° í•„ìš”í•œ ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ì°¸ê³ í•˜ê³  ìƒˆë¡œìš´ ì„¼ì„œ ì¶”ê°€ë‚˜ ë³€ê²½ì‹œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
3.i2c_scanner.py EG-Dash I2C ìŠ¤ìºë„ˆ ëª¨ë“ˆ (ë¼ì¦ˆë² ë¦¬íŒŒì´ ì „ìš©)ë¡œ ì‹¤ì œ I2C í•˜ë“œì›¨ì–´ë§Œ ì§€ì›í•©ë‹ˆë‹¤.
  ì´ ì½”ë“œëŠ” ìƒˆë¡œìš´ ì„¼ì„œê°€ ì¶”ê°€ë˜ë©´ ì¶”ê°€ëœ ì„¼ì„œì˜ I2C ì£¼ì†Œë¥¼ ìŠ¤ìº”í•˜ê³  ì„¼ì„œ ëª©ë¡ì— ì¶”ê°€í•˜ëŠ” ëª©ì ì„ ê°€ì§‘ë‹ˆë‹¤.
4.ê°ì¢… ì„¼ì„œë“¤ì€ sensor_manager.py      # ì„¼ì„œ ê´€ë¦¬ ëª¨ë“ˆ
 ì„ í†µí•´ ê´€ë¦¬ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
 ê·¸ëŸ¬ë‚˜ ì„¼ì„œê°€ ëŠ˜ì–´ ë‚˜ë©´ sensor_manager.py ê°€ ë„ˆë¬´ ë¹„ëŒ€í•´ì§€ê³  ë³µì¡í•´ ì§‘ë‹ˆë‹¤. ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
 ê° ì„¼ì„œë³„ class íŒŒì¼ì„ ë”°ë¡œ ë§Œë“¤ì–´ sensor_manager.pyì™€ ì—°ë™ ë˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.
 ì´ëŸ° ì„¼ì„œìš© class íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
 sdp810_sensor.py, simpleBME688.py, simpleEddy.py, sdp810_sensor.py ê°€ ìˆìŠµë‹ˆë‹¤.

ìœ„ ë‚´ìš©ìœ¼ë¡œ êµ¬í˜„ë˜ê³  ìˆëŠ”ì§€ ê²€í† í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ í† ì˜í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.


<2>ë¬¸ì œë°œìƒ ë¡œê·¸
ì•„ë˜ ë¡œê·¸ëŠ” ìˆ˜ì • í›„ ë¼ì¦ˆë² ë¦¬íŒŒì´ 4B ëª¨ë¸ Bì—ì„œ ì‹¤í–‰í•œ ë¡œê·¸ì…ë‹ˆë‹¤. 
I2C ìŠ¤ìº” ê³¼ì •ì€ ë¬¸ì œ ì—†ì´ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.
BH1750 ì„¼ì„œì™€ SDP810 ì„¼ì„œ, SPS30 ì„¼ì„œ ì—°ê²° ê³¼ì •ì€ ë¬¸ì œ ì—†ì´ ì˜ ë˜ì—ˆìŠµë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ ë©”ì¸ ëŒ€ì‹œë³´ë“œì—ì„œëŠ” SPS30 ì„¼ì„œ ë°ì´í„°ê°€ ë‚˜ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤.(ì—°ê²°ë˜ì§€ ì•ŠìŒ)
ë¡œê·¸ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: ShdlcSerialPort.__init__() got an unexpected keyword argument 'timeout'
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?
í˜¹ì‹œ ì´ˆê¸°í™” ì‹œê°„ì´ ë„ˆë¬´ ì§§ì€ ë¬¸ì œëŠ” ì•„ë‹Œê°€ìš”? 
ì¼ë‹¨ ì´ ë‘ê°€ì§€ ë¬¸ì œì— ì§‘ì¤‘í•˜ì—¬ í•´ê²°í•˜ê³  Settings í˜ì´ì§€ ë¬¸ì œë¥¼ ì˜ë…¼ í•˜ê² ìŠµë‹ˆë‹¤.

shinho@shinhotech:~/egdash $ python sensor_api_simple.py
============================================================
EZ-Dash ì‹¬í”Œ ì„¼ì„œ ëŒ€ì‹œë³´ë“œ ì„œë²„
============================================================
ì„¼ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...
â„¹ï¸ ê¸°ë³¸ ì„¼ì„œ ì´ë¯¸ ì¡´ì¬: SPS30 (UART)
I2C ìŠ¤ìºë„ˆ ì´ˆê¸°í™” ì¤‘...
ì‹¤ì œ ì„¼ì„œ ì—°ê²° ì¤‘...
ğŸš€ ì„¼ì„œ ê´€ë¦¬ì ì´ˆê¸°í™” (ë¼ì¦ˆë² ë¦¬íŒŒì´ ì „ìš© - ë©€í‹° ì„¼ì„œ ì§€ì›)
ğŸ” ì„¼ì„œ ê²€ìƒ‰ ë° ì´ˆê¸°í™” ì‹œì‘...
âœ… I2C ë²„ìŠ¤ 0 ì—°ê²° ì™„ë£Œ
âœ… I2C ë²„ìŠ¤ 1 ì—°ê²° ì™„ë£Œ
ğŸ” SHT40 ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
âŒ SHT40 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
âŒ SHT40 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
âŒ SHT40 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
âŒ SHT40 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
âŒ SHT40 ì„¼ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
ğŸ” BME688 ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
âŒ BME688 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 121] Remote I/O error
âŒ BME688 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 121] Remote I/O error
âŒ BME688 ì„¼ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
ğŸ” BH1750 ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
âŒ BH1750 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
âŒ BH1750 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
âœ… BH1750 ì„¼ì„œ ì´ˆê¸°í™” ì™„ë£Œ (ì£¼ì†Œ: 0x23)
âœ… BH1750 ì„¼ì„œ ë°œê²¬ (ë²„ìŠ¤ 1, ì£¼ì†Œ 0x23) - BH1750-1
âŒ BH1750 ì´ˆê¸°í™” ì‹¤íŒ¨: [Errno 5] Input/output error
ğŸ” SDP810 ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
âœ… SDP810 ì„¼ì„œ ì´ˆê¸°í™” ì™„ë£Œ (ì£¼ì†Œ: 0x25) - ì••ë ¥: -0.0 Pa
âœ… SDP810 ì„¼ì„œ ë°œê²¬ (ë²„ìŠ¤ 0, ì£¼ì†Œ 0x25) - SDP810-1 0.0 Pa âœ“
ğŸ” SPS30 ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
ğŸ” SPS30 ë¯¸ì„¸ë¨¼ì§€ ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
ğŸ” SPS30 ì„¼ì„œ ê²€ìƒ‰ ì¤‘...
ğŸ”Œ í¬íŠ¸ í…ŒìŠ¤íŠ¸ ì¤‘: /dev/ttyUSB0
âœ… SPS30 ì„¼ì„œ ë°œê²¬: /dev/ttyUSB0 (S/N: DE4D47ABB1B28468)
ğŸ”Œ SPS30 ì„¼ì„œ ì—°ê²° ì‹œë„: /dev/ttyUSB0
âœ… SPS30 ì„¼ì„œ ì—°ê²° ì„±ê³µ
ğŸ“Š ì‹œë¦¬ì–¼ ë²ˆí˜¸: DE4D47ABB1B28468
âœ… SPS30-1 ì—°ê²° ì„±ê³µ (í¬íŠ¸: /dev/ttyUSB0, S/N: DE4D47ABB1B28468)
ğŸ“Š SPS30 ì„¼ì„œ ê²€ìƒ‰ ì™„ë£Œ: 1ê°œ ë°œê²¬
ğŸ“Š ì„¼ì„œ ì´ˆê¸°í™” ì™„ë£Œ: 3/5ê°œ ì„¼ì„œ ì—°ê²°
ì„¼ì„œ ì´ˆê¸°í™” ì™„ë£Œ: 3/2ê°œ ì„¼ì„œ ì—°ê²°

âœ… ì„¼ì„œ ì—°ê²° ì„±ê³µ

ğŸš€ ì„œë²„ ì‹œì‘: http://0.0.0.0:5003
Ctrl+Cë¡œ ì¢…ë£Œ

 * Serving Flask app 'sensor_api_simple'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5003
 * Running on http://192.168.0.39:5003
Press CTRL+C to quit
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current-sensor/sht40 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current-sensor/bh1750 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current-sensor/virtual HTTP/1.1" 404 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: ShdlcSerialPort.__init__() got an unexpected keyword argument 'timeout'
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: ShdlcSerialPort.__init__() got an unexpected keyword argument 'timeout'
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: ShdlcSerialPort.__init__() got an unexpected keyword argument 'timeout'
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: ShdlcSerialPort.__init__() got an unexpected keyword argument 'timeout'
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current HTTP/1.1" 200 -
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨: ShdlcSerialPort.__init__() got an unexpected keyword argument 'timeout'
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
âš ï¸ sps30 ì„¼ì„œ 5íšŒ ì—°ì† ì˜¤ë¥˜ - ì„¼ì„œ ë¹„í™œì„±í™”
ğŸ’¡ ìˆ˜ë™ ìŠ¤ìº”ì„ í†µí•´ ì„¼ì„œë¥¼ ë‹¤ì‹œ ì—°ê²°í•˜ì„¸ìš”.
192.168.0.40 - - [16/Jun/2025 14:27:13] "GET /api/current HTTP/1.1" 200 -
192.168.0.40 - - [16/Jun/2025 14:27:14] "GET /api/current-sensor/bh1750 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:14] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
âŒ SPS30 ê°ì²´ê°€ Noneì…ë‹ˆë‹¤
192.168.0.40 - - [16/Jun/2025 14:27:14] "GET /api/current HTTP/1.1" 200 -
âŒ SPS30 ê°ì²´ê°€ Noneì…ë‹ˆë‹¤
192.168.0.40 - - [16/Jun/2025 14:27:14] "GET /api/current HTTP/1.1" 200 -
192.168.0.40 - - [16/Jun/2025 14:27:14] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
âŒ SPS30 ê°ì²´ê°€ Noneì…ë‹ˆë‹¤
192.168.0.40 - - [16/Jun/2025 14:27:14] "GET /api/current HTTP/1.1" 200 -
192.168.0.40 - - [16/Jun/2025 14:27:15] "GET /api/current-sensor/bme688 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:15] "GET /api/current-sensor/bh1750 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:15] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:15] "GET /api/current-sensor/sps30 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:27:15] "GET /api/current-sensor/virtual HTTP/1.1" 404 -
âŒ SPS30 ê°ì²´ê°€ Noneì…ë‹ˆë‹¤


SPS30 ì„¼ì„œ ë°ì´í„° ì½ê¸° ë¬¸ì œëŠ” ì—¬ì „í•©ë‹ˆë‹¤.
192.168.0.40 - - [16/Jun/2025 14:44:05] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
192.168.0.40 - - [16/Jun/2025 14:44:06] "GET /api/current-sensor/bme688 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:06] "GET /api/current-sensor/bh1750 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:06] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:06] "GET /api/current-sensor/sps30 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:06] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current-sensor/bh1750 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current-sensor/virtual HTTP/1.1" 404 -
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current-sensor/sdp810 HTTP/1.1" 404 -
ğŸ” SPS30 ì›ì‹œ ë°ì´í„°: ((15.336994171142578, 16.372400283813477, 16.496505737304688, 16.560749053955078), (105.506591796875, 121.83389282226562, 122.37937927246094, 122.44132995605469, 122.46612548828125), 0.5169452428817749) (ê¸¸ì´: 3)
âœ… SPS30 ë°ì´í„° ì½ê¸° ì„±ê³µ: PM1.0=15.3, PM2.5=105.5, PM4.0=0.0, PM10=0.5Î¼g/mÂ³
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
SHDLC device with address 0 returned error 67.
âš ï¸ SPS30 ì¸¡ì • ì‹œì‘ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): SHDLC device returned error code 67: Command not allowed in current state
ğŸ” SPS30 ì›ì‹œ ë°ì´í„°: None (ê¸¸ì´: 0)
âš ï¸ SPS30 ë°ì´í„° ë¶€ì¡±: 0ê°œ
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
SHDLC device with address 0 returned error 67.
âš ï¸ SPS30 ì¸¡ì • ì‹œì‘ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): SHDLC device returned error code 67: Command not allowed in current state
ğŸ” SPS30 ì›ì‹œ ë°ì´í„°: None (ê¸¸ì´: 0)
âš ï¸ SPS30 ë°ì´í„° ë¶€ì¡±: 0ê°œ
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
SHDLC device with address 0 returned error 67.
âš ï¸ SPS30 ì¸¡ì • ì‹œì‘ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): SHDLC device returned error code 67: Command not allowed in current state
ğŸ” SPS30 ì›ì‹œ ë°ì´í„°: None (ê¸¸ì´: 0)
âš ï¸ SPS30 ë°ì´í„° ë¶€ì¡±: 0ê°œ
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
SHDLC device with address 0 returned error 67.
âš ï¸ SPS30 ì¸¡ì • ì‹œì‘ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): SHDLC device returned error code 67: Command not allowed in current state
ğŸ” SPS30 ì›ì‹œ ë°ì´í„°: None (ê¸¸ì´: 0)
âš ï¸ SPS30 ë°ì´í„° ë¶€ì¡±: 0ê°œ
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
192.168.0.40 - - [16/Jun/2025 14:44:07] "GET /api/current HTTP/1.1" 200 -
ğŸ” SPS30 ë°ì´í„° ì½ê¸° ì‹œë„... (ì—°ê²°ìƒíƒœ: True)
SHDLC device with address 0 returned error 67.
âš ï¸ SPS30 ì¸¡ì • ì‹œì‘ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œë¨): SHDLC device returned error code 67: Command not allowed in current state
ğŸ” SPS30 ì›ì‹œ ë°ì´í„°: None (ê¸¸ì´: 0)
âš ï¸ SPS30 ë°ì´í„° ë¶€ì¡±: 0ê°œ
âŒ SPS30 ë°ì´í„° ì½ê¸° ì‹¤íŒ¨ - read_data() ë°˜í™˜ê°’ì´ None
âš ï¸ sps30 ì„¼ì„œ 5íšŒ ì—°ì† ì˜¤ë¥˜ - ì„¼ì„œ ë¹„í™œì„±í™”
ğŸ’¡ ìˆ˜ë™ ìŠ¤ìº”ì„ í†µí•´ ì„¼ì„œë¥¼ ë‹¤ì‹œ ì—°ê²°í•˜ì„¸ìš”.

ì•„ë˜ ì½”ë“œëŠ” í˜„ì¬ SPS30 ì„¼ì„œ ì˜ì½ê³  ë°ì´í„° ì˜ ë‚˜ì˜¤ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
ì´ ì½”ë“œë¥¼ í†µí•´ ë¬¸ì œë¥¼ í•´ê²°í•´ ì£¼ì„¸ìš”.

import tkinter as tk
from tkinter import ttk, messagebox
import ttkbootstrap as tb
from ttkbootstrap.constants import *
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
from matplotlib.figure import Figure
import matplotlib.dates as mdates

# ë¼ì¦ˆë² ë¦¬íŒŒì´ìš© í°íŠ¸ ì„¤ì •
try:
    # ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í°íŠ¸ ì„¤ì •
    plt.rcParams['font.family'] = 'DejaVu Sans'
    plt.rcParams['axes.unicode_minus'] = False
except:
    # í°íŠ¸ ì„¤ì • ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©
    plt.rcParams['font.family'] = 'sans-serif'

from datetime import datetime, timedelta
import threading
import time
import queue
import glob
from collections import deque

# SPS30 ê´€ë ¨ imports
from shdlc_sps30 import Sps30ShdlcDevice
from sensirion_shdlc_driver import ShdlcSerialPort, ShdlcConnection
from sensirion_shdlc_driver.errors import ShdlcError

class SPS30Monitor:
    def __init__(self):
        # ë°ì´í„° ì €ì¥ìš© deque (ìµœëŒ€ 60ê°œ ë°ì´í„° í¬ì¸íŠ¸ - ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„±ëŠ¥ ê³ ë ¤)
        self.max_points = 60
        self.timestamps = deque(maxlen=self.max_points)
        self.pm1_data = deque(maxlen=self.max_points)
        self.pm25_data = deque(maxlen=self.max_points)
        self.pm4_data = deque(maxlen=self.max_points)
        self.pm10_data = deque(maxlen=self.max_points)
        
        # ì„¼ì„œ ê´€ë ¨
        self.device = None
        self.port = None
        self.is_monitoring = False
        self.sensor_thread = None
        self.data_queue = queue.Queue()
        self.port_name = None
        self.sensor_ready = False
        
        # GUI ì´ˆê¸°í™” (ìµœìš°ì„ )
        self.setup_gui()
        
        # GUI ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì‹œì‘
        self.update_gui()
        
        # ì„¼ì„œ ê²€ìƒ‰ì„ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
        self.sensor_detection_thread = threading.Thread(target=self.background_sensor_detection, daemon=True)
        self.sensor_detection_thread.start()
        
    def find_serial_port(self):
        """ë¼ì¦ˆë² ë¦¬íŒŒì´/Linuxì—ì„œ USB ì‹œë¦¬ì–¼ í¬íŠ¸ ìë™ íƒìƒ‰"""
        # ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œ ì¼ë°˜ì ì¸ USB ì‹œë¦¬ì–¼ í¬íŠ¸ íŒ¨í„´
        candidates = glob.glob('/dev/ttyUSB*') + glob.glob('/dev/ttyACM*') + glob.glob('/dev/ttyAMA*')
        if not candidates:
            return None
        return candidates[0]
    
    def setup_gui(self):
        """GUI ì´ˆê¸°í™” - ë¼ì¦ˆë² ë¦¬íŒŒì´ í™”ë©´ í¬ê¸°ì— ë§ê²Œ ì¡°ì •"""
        self.root = tb.Window(
            title="SPS30 ë¯¸ì„¸ë¨¼ì§€ ëª¨ë‹ˆí„°",
            themename="solar",
            size=(800, 480),
            resizable=(False, False)  # ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ì„œëŠ” ê³ ì • í¬ê¸°
        )
        self.root.geometry("800x480+0+0")
        
        # ë©”ì¸ ì»¨í…Œì´ë„ˆ (íŒ¨ë”© ì¶•ì†Œ)
        main_frame = tb.Frame(self.root, padding=8)
        main_frame.pack(fill=BOTH, expand=True)
        
        # ìƒë‹¨ í—¤ë” (ê³ ì • ë†’ì´)
        self.setup_header(main_frame)
        
        # ì¤‘ì•™ ì»¨í…ì¸  (ì¸¡ì •ê°’ + ì°¨íŠ¸) - ë†’ì´ ì œí•œ
        content_frame = tb.Frame(main_frame, height=300)  # ëª…ì‹œì  ë†’ì´ ì„¤ì •
        content_frame.pack(fill=X, pady=(5, 0))
        content_frame.pack_propagate(False)  # ë†’ì´ ê³ ì •
        
        # ì¸¡ì •ê°’ í‘œì‹œ ì˜ì—­ (ì™¼ìª½)
        self.setup_measurement_panel(content_frame)
        
        # ì°¨íŠ¸ ì˜ì—­ (ì˜¤ë¥¸ìª½)
        self.setup_chart_panel(content_frame)
        
        # í•˜ë‹¨ ìƒíƒœë°” (ê³ ì • ë†’ì´)
        self.setup_status_bar(main_frame)
        
        # ë””ë²„ê·¸ ë¡œê·¸ ì˜ì—­ (ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì‚¬ìš©)
        self.setup_debug_log(main_frame)
        
    def setup_header(self, parent):
        """ìƒë‹¨ í—¤ë” ì„¤ì • - ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ë§ê²Œ ì¶•ì†Œ"""
        header_frame = tb.Frame(parent)
        header_frame.pack(fill=X, pady=(0, 3))  # íŒ¨ë”© ë” ì¶•ì†Œ
        
        # ì œëª© (í°íŠ¸ í¬ê¸° ì¶•ì†Œ)
        title_label = tb.Label(
            header_frame, 
            text="SPS30 ë¯¸ì„¸ë¨¼ì§€ ëª¨ë‹ˆí„°", 
            font=("DejaVu Sans", 16, "bold"),
            foreground="#2E86AB"
        )
        title_label.pack(side=LEFT)
        
        # ë²„íŠ¼ í”„ë ˆì„
        button_frame = tb.Frame(header_frame)
        button_frame.pack(side=RIGHT)
        
        # ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼ (í¬ê¸° ì¶•ì†Œ)
        self.start_button = tb.Button(
            button_frame,
            text="ì¸¡ì • ì‹œì‘",
            command=self.toggle_monitoring,
            style="success.TButton",
            width=10
        )
        self.start_button.pack(side=RIGHT, padx=(3, 0))  # íŒ¨ë”© ì¶•ì†Œ
        
        # ì„¼ì„œ ìƒíƒœ í‘œì‹œ (í°íŠ¸ í¬ê¸° ì¶•ì†Œ)
        self.sensor_status = tb.Label(
            button_frame,
            text="ì„¼ì„œ ê²€ìƒ‰ ì¤‘...",
            font=("DejaVu Sans", 10),
            foreground="#F18F01"
        )
        self.sensor_status.pack(side=RIGHT, padx=(0, 3))  # íŒ¨ë”© ì¶•ì†Œ
        
    def setup_measurement_panel(self, parent):
        """ì¸¡ì •ê°’ í‘œì‹œ íŒ¨ë„ - ë¼ì¦ˆë² ë¦¬íŒŒì´ í™”ë©´ì— ë§ê²Œ ì»´íŒ©íŠ¸í•˜ê²Œ"""
        measurement_frame = tb.LabelFrame(
            parent, 
            text="í˜„ì¬ ì¸¡ì •ê°’", 
            padding=8,  # íŒ¨ë”© ì¶•ì†Œ
            style="info.TLabelframe"
        )
        measurement_frame.pack(side=LEFT, fill=BOTH, expand=True, padx=(0, 3))
        
        # ì‘ì€ í™”ë©´ì— ë§ê²Œ í°íŠ¸ í¬ê¸° ì¡°ì •
        label_font_size = 10
        value_font_size = 12
        unit_font_size = 8
        
        # PM2.5ì™€ PM10ì„ ìœ„ìª½ì— í° ê¸€ì”¨ë¡œ (ê°€ì¥ ì¤‘ìš”)
        important_frame = tb.Frame(measurement_frame)
        important_frame.pack(fill=X, pady=(0, 5))  # ì—¬ë°± ì¶•ì†Œ
        
        # PM2.5 (ì™¼ìª½)
        pm25_frame = tb.Frame(important_frame)
        pm25_frame.pack(side=LEFT, fill=X, expand=True)
        
        tb.Label(pm25_frame, text="PM2.5", font=("DejaVu Sans", label_font_size, "bold")).pack()
        self.pm25_value = tb.Label(
            pm25_frame, 
            text="--", 
            font=("DejaVu Sans", value_font_size, "bold"),
            foreground="#E63946"
        )
        self.pm25_value.pack()
        tb.Label(pm25_frame, text="Î¼g/mÂ³", font=("DejaVu Sans", unit_font_size)).pack()
        
        # PM10 (ì˜¤ë¥¸ìª½)
        pm10_frame = tb.Frame(important_frame)
        pm10_frame.pack(side=RIGHT, fill=X, expand=True)
        
        tb.Label(pm10_frame, text="PM10", font=("DejaVu Sans", label_font_size, "bold")).pack()
        self.pm10_value = tb.Label(
            pm10_frame, 
            text="--", 
            font=("DejaVu Sans", value_font_size, "bold"),
            foreground="#F77F00"
        )
        self.pm10_value.pack()
        tb.Label(pm10_frame, text="Î¼g/mÂ³", font=("DejaVu Sans", unit_font_size)).pack()
        
        # PM1.0ê³¼ PM4.0ì„ ì•„ë˜ìª½ì— ì‘ì€ ê¸€ì”¨ë¡œ
        small_frame = tb.Frame(measurement_frame)
        small_frame.pack(fill=X, pady=(5, 5))  # ì—¬ë°± ì¶•ì†Œ
        
        # PM1.0 (ì™¼ìª½)
        pm1_frame = tb.Frame(small_frame)
        pm1_frame.pack(side=LEFT, fill=X, expand=True)
        
        tb.Label(pm1_frame, text="PM1.0", font=("DejaVu Sans", 8, "bold")).pack()
        self.pm1_value = tb.Label(
            pm1_frame, 
            text="--", 
            font=("DejaVu Sans", 12, "bold"),
            foreground="#FCBF49"
        )
        self.pm1_value.pack()
        tb.Label(pm1_frame, text="Î¼g/mÂ³", font=("DejaVu Sans", 8)).pack()
        
        # PM4.0 (ì˜¤ë¥¸ìª½)
        pm4_frame = tb.Frame(small_frame)
        pm4_frame.pack(side=RIGHT, fill=X, expand=True)
        
        tb.Label(pm4_frame, text="PM4.0", font=("DejaVu Sans", 8, "bold")).pack()
        self.pm4_value = tb.Label(
            pm4_frame, 
            text="--", 
            font=("DejaVu Sans", 12, "bold"),
            foreground="#A663CC"
        )
        self.pm4_value.pack()
        tb.Label(pm4_frame, text="Î¼g/mÂ³", font=("DejaVu Sans", 8)).pack()
        
        # ê³µê¸°ì§ˆ ìƒíƒœ
        self.air_quality_frame = tb.Frame(measurement_frame)
        self.air_quality_frame.pack(fill=X, pady=(5, 0))  # ì—¬ë°± ì¶•ì†Œ
        
        self.air_quality_label = tb.Label(
            self.air_quality_frame,
            text="ê³µê¸°ì§ˆ ìƒíƒœ",
            font=("DejaVu Sans", 10, "bold")
        )
        self.air_quality_label.pack()
        
        self.air_quality_status = tb.Label(
            self.air_quality_frame,
            text="ì¸¡ì • ì¤€ë¹„",
            font=("DejaVu Sans", 10, "bold"),
            foreground="#6A994E"
        )
        self.air_quality_status.pack()
        
    def setup_chart_panel(self, parent):
        """ì°¨íŠ¸ íŒ¨ë„ ì„¤ì • - ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ë§ê²Œ í¬ê¸° ì¡°ì •"""
        chart_frame = tb.LabelFrame(
            parent, 
            text="ì‹¤ì‹œê°„ ì°¨íŠ¸", 
            padding=3,  # íŒ¨ë”© ë” ì¶•ì†Œ
            style="info.TLabelframe"
        )
        chart_frame.pack(side=RIGHT, fill=BOTH, expand=True)
        
        # matplotlib ì„¤ì • (ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„±ëŠ¥ ê³ ë ¤, í¬ê¸° ë” ì¶•ì†Œ)
        plt.style.use('dark_background')
        self.fig = Figure(figsize=(5, 3), dpi=75, facecolor='#2E3440')  # í¬ê¸° ë” ì¶•ì†Œ
        self.ax = self.fig.add_subplot(111, facecolor='#2E3440')
        
        # ì°¨íŠ¸ ìŠ¤íƒ€ì¼ë§ (í°íŠ¸ í¬ê¸° ì¶•ì†Œ)
        self.ax.set_xlabel('Time', color='#D8DEE9', fontsize=9)
        self.ax.set_ylabel('Î¼g/mÂ³', color='#D8DEE9', fontsize=9)
        self.ax.tick_params(colors='#D8DEE9', labelsize=8)
        self.ax.grid(True, alpha=0.3, color='#4C566A')
        
        # ë²”ë¡€ ì„¤ì • (ì–‡ì€ ì„ , ì‘ì€ ë§ˆì»¤)
        self.pm1_line, = self.ax.plot([], [], '-', color='#FCBF49', label='PM1.0', linewidth=1)
        self.pm25_line, = self.ax.plot([], [], '-', color='#E63946', label='PM2.5', linewidth=2)
        self.pm4_line, = self.ax.plot([], [], '-', color='#A663CC', label='PM4.0', linewidth=1)
        self.pm10_line, = self.ax.plot([], [], '-', color='#F77F00', label='PM10', linewidth=1)
        
        self.ax.legend(loc='upper left', framealpha=0.8, facecolor='#3B4252', fontsize=8)
        
        # ì°¨íŠ¸ë¥¼ tkinterì— ì„ë² ë“œ
        self.canvas = FigureCanvasTkAgg(self.fig, chart_frame)
        self.canvas.draw()
        self.canvas.get_tk_widget().pack(fill=BOTH, expand=True)
        
        # ì´ˆê¸° ì°¨íŠ¸ ì„¤ì •
        self.setup_chart()
        
    def setup_chart(self):
        """ì°¨íŠ¸ ì´ˆê¸° ì„¤ì •"""
        # ì‹œê°„ ë²”ìœ„ ì„¤ì • (ìµœê·¼ 5ë¶„ - ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„±ëŠ¥ ê³ ë ¤)
        now = datetime.now()
        self.ax.set_xlim(now - timedelta(minutes=5), now)
        self.ax.set_ylim(0, 50)
        
        # ì‹œê°„ ì¶• í¬ë§·
        self.ax.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M'))
        self.ax.xaxis.set_major_locator(mdates.MinuteLocator(interval=1))
        
    def setup_status_bar(self, parent):
        """í•˜ë‹¨ ìƒíƒœë°” - í¬ê¸° ì¶•ì†Œ"""
        status_frame = tb.Frame(parent)
        status_frame.pack(fill=X, pady=(5, 0))  # íŒ¨ë”© ì¶•ì†Œ
        
        # ìƒíƒœ í…ìŠ¤íŠ¸
        self.status_text = tb.Label(
            status_frame,
            text="ì¤€ë¹„",
            font=("DejaVu Sans", 9),
            foreground="#6A994E"
        )
        self.status_text.pack(side=LEFT)
        
        # í˜„ì¬ ì‹œê°„
        self.time_label = tb.Label(
            status_frame,
            text="",
            font=("DejaVu Sans", 9)
        )
        self.time_label.pack(side=RIGHT)
        
    def setup_debug_log(self, parent):
        """ë””ë²„ê·¸ ë¡œê·¸ ì˜ì—­ - í¬ê¸° í™•ëŒ€"""
        debug_frame = tb.LabelFrame(parent, text="ë¡œê·¸", padding=8)
        debug_frame.pack(fill=BOTH, expand=True, pady=(8, 0))  # expand=Trueë¡œ ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì‚¬ìš©
        
        # ë¡œê·¸ í…ìŠ¤íŠ¸ ì˜ì—­ (ë†’ì´ í™•ëŒ€)
        self.log_text = tk.Text(debug_frame, height=6, bg='#2E3440', fg='#D8DEE9', font=('monospace', 8))
        self.log_text.pack(fill=BOTH, expand=True)  # ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì‚¬ìš©
        
    def log_message(self, message):
        """ë””ë²„ê·¸ ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_entry = f"[{timestamp}] {message}\n"
        
        self.log_text.insert(tk.END, log_entry)
        self.log_text.see(tk.END)
        
        # ë¡œê·¸ê°€ ë„ˆë¬´ ë§ì•„ì§€ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ (ë¼ì¦ˆë² ë¦¬íŒŒì´ ë©”ëª¨ë¦¬ ê³ ë ¤)
        lines = self.log_text.get("1.0", tk.END).split('\n')
        if len(lines) > 20:  # ë¼ì¸ ìˆ˜ ì¶•ì†Œ
            self.log_text.delete("1.0", "5.0")
        
        print(log_entry.strip())  # ì½˜ì†”ì—ë„ ì¶œë ¥
        
    def background_sensor_detection(self):
        """ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„¼ì„œ ê²€ìƒ‰ ë° ì—°ê²° í…ŒìŠ¤íŠ¸"""
        try:
            # GUI ìŠ¤ë ˆë“œì—ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
            self.root.after(0, lambda: self.sensor_status.config(text="ì„¼ì„œ ê²€ìƒ‰ ì¤‘...", foreground="#F18F01"))
            
            # ì„¼ì„œ í¬íŠ¸ ê²€ìƒ‰
            self.port_name = self.find_serial_port()
            if not self.port_name:
                self.root.after(0, lambda: self.sensor_status.config(text="ì„¼ì„œ ì—†ìŒ", foreground="#E63946"))
                self.root.after(0, lambda: self.log_message("ì„¼ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."))
                return
                
            self.root.after(0, lambda: self.log_message(f"ì„¼ì„œ í¬íŠ¸ ë°œê²¬: {self.port_name}"))
            
            # ì„¼ì„œ ì—°ê²° í…ŒìŠ¤íŠ¸ (ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ë¶€ë¶„)
            self.root.after(0, lambda: self.sensor_status.config(text="ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...", foreground="#F18F01"))
            
            with ShdlcSerialPort(port=self.port_name, baudrate=115200) as port:
                device = Sps30ShdlcDevice(ShdlcConnection(port))
                
                # ì„¼ì„œ ì •ë³´ í™•ì¸
                serial_number = device.device_information_serial_number()
                self.sensor_ready = True
                
                # GUI ìŠ¤ë ˆë“œì—ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
                self.root.after(0, lambda: self.sensor_status.config(
                    text=f"ì„¼ì„œ ì—°ê²°ë¨ ({serial_number[:6]}...)", 
                    foreground="#6A994E"
                ))
                self.root.after(0, lambda: self.log_message(f"ì„¼ì„œ ì—°ê²° ì„±ê³µ: {serial_number}"))
                
        except Exception as e:
            self.root.after(0, lambda: self.sensor_status.config(text="ì—°ê²° ì‹¤íŒ¨", foreground="#E63946"))
            self.root.after(0, lambda: self.log_message(f"ì„¼ì„œ ê²€ìƒ‰ ì˜¤ë¥˜: {e}"))
    
    def toggle_monitoring(self):
        """ì¸¡ì • ì‹œì‘/ì¤‘ì§€"""
        if not self.port_name:
            messagebox.showerror("ì˜¤ë¥˜", "ì„¼ì„œê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return
            
        if not self.sensor_ready:
            messagebox.showwarning("ì•Œë¦¼", "ì„¼ì„œ ì—°ê²°ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")
            return
            
        if not self.is_monitoring:
            self.start_monitoring()
        else:
            self.stop_monitoring()
    
    def start_monitoring(self):
        """ì¸¡ì • ì‹œì‘"""
        try:
            self.is_monitoring = True
            self.start_button.config(text="ì¸¡ì • ì¤‘ì§€", style="warning.TButton")
            self.status_text.config(text="ì¸¡ì • ì¤‘...", foreground="#F18F01")
            self.log_message("ì¸¡ì • ì‹œì‘")
            
            # ì¸¡ì • ìŠ¤ë ˆë“œ ì‹œì‘
            self.sensor_thread = threading.Thread(target=self.sensor_loop, daemon=True)
            self.sensor_thread.start()
            
        except Exception as e:
            self.log_message(f"ì¸¡ì • ì‹œì‘ ì‹¤íŒ¨: {e}")
            messagebox.showerror("ì˜¤ë¥˜", f"ì¸¡ì • ì‹œì‘ ì‹¤íŒ¨: {e}")
    
    def stop_monitoring(self):
        """ì¸¡ì • ì¤‘ì§€"""
        self.is_monitoring = False
        self.start_button.config(text="ì¸¡ì • ì‹œì‘", style="success.TButton")
        self.status_text.config(text="ì¸¡ì • ì¤‘ì§€ë¨", foreground="#6A994E")
        self.log_message("ì¸¡ì • ì¤‘ì§€")
    
    def sensor_loop(self):
        """ì„¼ì„œ ë°ì´í„° ì½ê¸° ë£¨í”„"""
        device = None
        try:
            self.log_message("ì„¼ì„œ ì—°ê²° ì¤‘...")
            
            with ShdlcSerialPort(port=self.port_name, baudrate=115200) as port:
                device = Sps30ShdlcDevice(ShdlcConnection(port))
                
                # ì„¼ì„œ ì´ˆê¸°í™”
                try:
                    device.device_reset()
                    self.log_message("ì„¼ì„œ ë¦¬ì…‹ ì™„ë£Œ")
                    time.sleep(2)
                except Exception as e:
                    self.log_message(f"ì„¼ì„œ ë¦¬ì…‹ ì‹¤íŒ¨: {e}")

                # ê¸°ë³¸ ì •ë³´ í™•ì¸
                serial_number = device.device_information_serial_number()
                self.log_message(f"ì‹œë¦¬ì–¼: {serial_number}")
                
                # ì¸¡ì • ì‹œì‘
                device.start_measurement()
                self.log_message("ì„¼ì„œ ì¤€ë¹„ ì¤‘...")
                time.sleep(5)
                
                # ë°ì´í„° ìˆ˜ì§‘ ë£¨í”„
                while self.is_monitoring:
                    try:
                        data = device.read_measured_value()
                        if data and len(data) >= 3:  # ìµœì†Œ 3ê°œ ë°ì´í„°ë©´ ì¶©ë¶„
                            # ì•ˆì „í•œ ìˆ«ì ë³€í™˜ í•¨ìˆ˜
                            def safe_float(value):
                                try:
                                    if isinstance(value, (int, float)):
                                        return float(value)
                                    elif isinstance(value, str):
                                        return float(value)
                                    elif isinstance(value, tuple) and len(value) > 0:
                                        return float(value[0])  # íŠœí”Œì˜ ì²« ë²ˆì§¸ ê°’ ì‚¬ìš©
                                    elif hasattr(value, '__float__'):
                                        return float(value)
                                    else:
                                        return 0.0
                                except Exception:
                                    return 0.0
                            
                            timestamp = datetime.now()
                            pm1_val = safe_float(data[0])
                            pm25_val = safe_float(data[1])
                            pm10_val = safe_float(data[2])
                            
                            measurement = {
                                'timestamp': timestamp,
                                'pm1': pm1_val,
                                'pm25': pm25_val,
                                'pm4': 0.0,  # 3ê°œ ë°ì´í„°ì¸ ê²½ìš° PM4.0 ì—†ìŒ
                                'pm10': pm10_val
                            }
                            
                            # ë°ì´í„° ê°œìˆ˜ì— ë”°ë¥¸ ì²˜ë¦¬
                            if len(data) >= 4:
                                pm4_val = safe_float(data[2])
                                pm10_val = safe_float(data[3])
                                measurement['pm4'] = pm4_val
                                measurement['pm10'] = pm10_val
                                self.log_message(f"PM1.0={pm1_val:.1f} PM2.5={pm25_val:.1f} PM4.0={pm4_val:.1f} PM10={pm10_val:.1f}")
                            else:
                                # 3ê°œ ë°ì´í„°: PM1.0, PM2.5, PM10
                                self.log_message(f"PM1.0={pm1_val:.1f} PM2.5={pm25_val:.1f} PM10={pm10_val:.1f}")
                            
                            self.data_queue.put(measurement)
                        else:
                            self.log_message(f"ë°ì´í„° ë¶€ì¡±: ë°›ì€ ê°œìˆ˜={len(data) if data else 0}")
                        
                        time.sleep(3)  # ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„±ëŠ¥ ê³ ë ¤í•˜ì—¬ 3ì´ˆ ê°„ê²©
                    except Exception as e:
                        self.log_message(f"ë°ì´í„° ì¤€ë¹„ ì¤‘... ({e})")
                        time.sleep(1)
                
                # ì¸¡ì • ì¤‘ì§€
                if device:
                    device.stop_measurement()
                    self.log_message("ì„¼ì„œ ì¸¡ì • ì¤‘ì§€")
                    
        except Exception as e:
            self.log_message(f"ì„¼ì„œ ë£¨í”„ ì˜¤ë¥˜: {e}")
            if device:
                try:
                    device.stop_measurement()
                except:
                    pass
    
    def get_air_quality_status(self, pm25_value):
        """PM2.5 ê°’ì— ë”°ë¥¸ ê³µê¸°ì§ˆ ìƒíƒœ ë°˜í™˜ (í•œêµ­ ê¸°ì¤€)"""
        if pm25_value <= 15:
            return "ì¢‹ìŒ", "#6A994E"
        elif pm25_value <= 35:
            return "ë³´í†µ", "#F18F01"
        elif pm25_value <= 75:
            return "ë‚˜ì¨", "#F77F00"
        else:
            return "ë§¤ìš° ë‚˜ì¨", "#E63946"
    
    def update_gui(self):
        """GUI ì—…ë°ì´íŠ¸"""
        # í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        current_time = datetime.now().strftime("%H:%M:%S")
        self.time_label.config(text=current_time)
        
        # ì„¼ì„œ ë°ì´í„° ì²˜ë¦¬
        data_updated = False
        while not self.data_queue.empty():
            try:
                data = self.data_queue.get_nowait()
                
                # ë°ì´í„° ì €ì¥
                self.timestamps.append(data['timestamp'])
                self.pm1_data.append(data['pm1'])
                self.pm25_data.append(data['pm25'])
                self.pm4_data.append(data['pm4'])
                self.pm10_data.append(data['pm10'])
                
                # ì¸¡ì •ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
                self.pm1_value.config(text=f"{data['pm1']:.1f}")
                self.pm25_value.config(text=f"{data['pm25']:.1f}")
                self.pm10_value.config(text=f"{data['pm10']:.1f}")
                
                # PM4.0ì€ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œ
                if data['pm4'] > 0:
                    self.pm4_value.config(text=f"{data['pm4']:.1f}")
                else:
                    self.pm4_value.config(text="--")
                
                # ê³µê¸°ì§ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
                status_text, status_color = self.get_air_quality_status(data['pm25'])
                self.air_quality_status.config(text=status_text, foreground=status_color)
                
                data_updated = True
                
            except queue.Empty:
                break
        
        # ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ëœ ê²½ìš°ì—ë§Œ)
        if data_updated:
            self.update_chart()
        
        # ë‹¤ìŒ ì—…ë°ì´íŠ¸ ì˜ˆì•½ (ë¼ì¦ˆë² ë¦¬íŒŒì´ ì„±ëŠ¥ ê³ ë ¤í•˜ì—¬ 2ì´ˆ ê°„ê²©)
        self.root.after(2000, self.update_gui)
    
    def update_chart(self):
        """ì°¨íŠ¸ ì—…ë°ì´íŠ¸"""
        if len(self.timestamps) > 0:
            # ë°ì´í„° ì—…ë°ì´íŠ¸
            self.pm1_line.set_data(self.timestamps, self.pm1_data)
            self.pm25_line.set_data(self.timestamps, self.pm25_data)
            self.pm10_line.set_data(self.timestamps, self.pm10_data)
            
            # PM4.0 ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì°¨íŠ¸ì— í‘œì‹œ
            if any(val > 0 for val in self.pm4_data):
                self.pm4_line.set_data(self.timestamps, self.pm4_data)
                self.pm4_line.set_visible(True)
            else:
                # PM4.0 ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¼ì¸ ìˆ¨ê¸°ê¸°
                self.pm4_line.set_visible(False)
            
            # ì¶• ë²”ìœ„ ì¡°ì •
            now = datetime.now()
            self.ax.set_xlim(now - timedelta(minutes=5), now)
            
            # Yì¶• ë²”ìœ„ ìë™ ì¡°ì • (0ì´ ì•„ë‹Œ ê°’ë“¤ë§Œ ê³ ë ¤)
            if self.pm25_data:
                all_values = list(self.pm1_data) + list(self.pm25_data) + list(self.pm10_data)
                if any(val > 0 for val in self.pm4_data):
                    all_values.extend([val for val in self.pm4_data if val > 0])
                
                if all_values:
                    max_val = max(all_values)
                    self.ax.set_ylim(0, max(max_val * 1.1, 30))
            
            # ì‹œê°„ ì¶• í¬ë§· ì¬ì„¤ì •
            self.ax.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M'))
            self.ax.xaxis.set_major_locator(mdates.MinuteLocator(interval=1))
            
            # ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            self.canvas.draw()
    
    def on_closing(self):
        """í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ì •ë¦¬"""
        self.log_message("í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
        self.stop_monitoring()
        time.sleep(1)
        self.root.destroy()
    
    def run(self):
        """í”„ë¡œê·¸ë¨ ì‹¤í–‰"""
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
        self.root.mainloop()

if __name__ == "__main__":
    try:
        monitor = SPS30Monitor()
        monitor.run()
    except KeyboardInterrupt:
        print("\ní”„ë¡œê·¸ë¨ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    finally:
        print("í”„ë¡œê·¸ë¨ ì¢…ë£Œ")




